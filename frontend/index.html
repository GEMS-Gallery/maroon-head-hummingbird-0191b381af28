<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileBox</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.28.0/feather.min.js"></script>
    <script src="https://unpkg.com/@dfinity/agent/lib/index.js"></script>
    <script src="https://unpkg.com/@dfinity/candid/lib/index.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            color: #333;
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 250px;
            background-color: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            padding: 1rem;
        }
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        header {
            border-bottom: 1px solid #e0e0e0;
            padding: 1rem;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            width: 100%;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 {
            font-size: 1.5rem;
            margin: 0;
        }
        .upload-btn {
            background-color: #000;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .upload-btn:hover {
            background-color: #333;
        }
        .search-container {
            margin: 1rem 0;
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 0.5rem 1rem 0.5rem 2.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        .files-container {
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .files-header {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .files-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .file-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-item:hover {
            background-color: #f0f0f0;
        }
        .file-icon {
            margin-right: 1rem;
            width: 24px;
            height: 24px;
        }
        .file-preview {
            width: 40px;
            height: 40px;
            margin-right: 1rem;
            object-fit: cover;
            border-radius: 4px;
        }
        .file-details {
            flex-grow: 1;
        }
        .file-name {
            margin: 0;
            font-weight: 500;
        }
        .file-info {
            font-size: 0.875rem;
            color: #666;
        }
        .file-actions {
            display: flex;
            gap: 0.5rem;
        }
        .icon-file-text { color: #4299e1; }
        .icon-folder { color: #ecc94b; }
        .icon-code { color: #805ad5; }
        .icon-image { color: #48bb78; }
        .icon-music { color: #ed64a6; }
        .icon-archive { color: #ed8936; }
        .icon-film { color: #e53e3e; }
        .menu-category {
            margin-bottom: 1.5rem;
        }
        .menu-category h3 {
            font-size: 0.875rem;
            text-transform: uppercase;
            color: #666;
            margin-bottom: 0.5rem;
        }
        .menu-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            color: #333;
            text-decoration: none;
        }
        .menu-item:hover {
            background-color: #e0e0e0;
        }
        .menu-item i {
            margin-right: 0.5rem;
        }
        .menu-item.active {
            background-color: #e0e0e0;
            font-weight: bold;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            max-width: 500px;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
            cursor: pointer;
        }
        .upload-area:hover {
            background-color: #f0f0f0;
        }
        #fileInput {
            display: none;
        }
        #categorySelect {
            margin-top: 10px;
            width: 100%;
            padding: 5px;
        }
        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }
        .view-toggle button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
        }
        .view-toggle button.active {
            background-color: #e0e0e0;
            border-radius: 4px;
        }
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            padding: 1rem;
        }
        .file-item-grid {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .file-item-grid:hover {
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .file-preview-grid {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }
        .file-name-grid {
            font-weight: 500;
            margin: 0.5rem 0;
            word-break: break-word;
        }
        .file-info-grid {
            font-size: 0.75rem;
            color: #666;
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="menu-category">
            <h3>Files</h3>
            <a href="#" class="menu-item active" data-section="home">
                <i data-feather="home"></i> Home
            </a>
            <a href="#" class="menu-item" data-section="my-files">
                <i data-feather="file"></i> My Files
            </a>
            <a href="#" class="menu-item" data-section="shared">
                <i data-feather="share-2"></i> Shared
            </a>
        </div>
        <div class="menu-category">
            <h3>Categories</h3>
            <a href="#" class="menu-item" data-section="photos">
                <i data-feather="image"></i> Photos
            </a>
            <a href="#" class="menu-item" data-section="videos">
                <i data-feather="film"></i> Videos
            </a>
            <a href="#" class="menu-item" data-section="documents">
                <i data-feather="file-text"></i> Documents
            </a>
            <a href="#" class="menu-item" data-section="audio">
                <i data-feather="music"></i> Audio
            </a>
        </div>
        <div class="menu-category">
            <h3>Storage</h3>
            <a href="#" class="menu-item" data-section="trash">
                <i data-feather="trash-2"></i> Trash
            </a>
            <a href="#" class="menu-item" data-section="storage-usage">
                <i data-feather="hard-drive"></i> Storage Usage
            </a>
        </div>
    </aside>
    <div class="main-content">
        <header>
            <div class="container">
                <div class="header-content">
                    <h1>FileBox</h1>
                    <button class="upload-btn" id="uploadBtn">
                        <i data-feather="upload"></i>
                        Upload
                    </button>
                </div>
            </div>
        </header>
        
        <main class="container">
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search files and folders">
                <i data-feather="search" class="search-icon"></i>
            </div>
            
            <div class="files-container">
                <div class="files-header">
                    <h2 id="currentCategory">My Files</h2>
                    <div class="view-toggle">
                        <button id="gridViewBtn" onclick="setViewMode('grid')">
                            <i data-feather="grid"></i>
                        </button>
                        <button id="listViewBtn" onclick="setViewMode('list')">
                            <i data-feather="list"></i>
                        </button>
                    </div>
                </div>
                <div id="filesContainer"></div>
            </div>
        </main>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Upload File</h2>
            <div class="upload-area" id="dropArea">
                <p>Drag and drop files here or click to select files</p>
                <input type="file" id="fileInput" multiple>
            </div>
            <select id="categorySelect">
                <option value="">Select category (optional)</option>
                <option value="documents">Documents</option>
                <option value="photos">Photos</option>
                <option value="videos">Videos</option>
                <option value="audio">Audio</option>
                <option value="other">Other</option>
            </select>
        </div>
    </div>

    <script>
        let actor;
        let currentViewMode = 'list';
        let currentCategory = 'all';

        async function initializeActor() {
            const canisterId = 'rrkah-fqaaa-aaaaa-aaaaq-cai'; // Replace with your actual canister ID
            const agent = new window.ic.agent.HttpAgent();
            await agent.fetchRootKey();
            actor = window.ic.actor.createActor(canisterInterface, { agent, canisterId });
        }

        async function fetchFiles() {
            try {
                if (currentCategory === 'all' || currentCategory === 'my-files') {
                    return await actor.getFiles();
                } else if (currentCategory === 'trash') {
                    return await actor.getTrashFiles();
                } else {
                    return await actor.getFilesByCategory(currentCategory);
                }
            } catch (error) {
                console.error('Error fetching files:', error);
                return [];
            }
        }

        function setViewMode(mode) {
            currentViewMode = mode;
            document.getElementById('gridViewBtn').classList.toggle('active', mode === 'grid');
            document.getElementById('listViewBtn').classList.toggle('active', mode === 'list');
            renderFiles();
        }

        async function renderFiles() {
            const filesContainer = document.getElementById('filesContainer');
            filesContainer.innerHTML = '';
            
            const files = await fetchFiles();
            
            if (currentViewMode === 'list') {
                filesContainer.className = 'files-list';
                files.forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.innerHTML = `
                        <img src="data:image/png;base64,${file.content}" alt="${file.name} preview" class="file-preview">
                        <i data-feather="${getFileIcon(file.fileType)}" class="file-icon icon-${getFileIcon(file.fileType)}"></i>
                        <div class="file-details">
                            <p class="file-name">${file.name}</p>
                            <p class="file-info">${formatFileSize(file.size)} - ${file.category}</p>
                        </div>
                        <div class="file-actions">
                            ${!file.inTrash ? `<i data-feather="trash-2" class="trash-icon" onclick="moveToTrash(${file.id})"></i>` : ''}
                            ${file.inTrash ? `<i data-feather="refresh-cw" class="restore-icon" onclick="restoreFromTrash(${file.id})"></i>` : ''}
                        </div>
                    `;
                    filesContainer.appendChild(li);
                });
            } else {
                filesContainer.className = 'files-grid';
                files.forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'file-item-grid';
                    div.innerHTML = `
                        <img src="data:image/png;base64,${file.content}" alt="${file.name} preview" class="file-preview-grid">
                        <p class="file-name-grid">${file.name}</p>
                        <p class="file-info-grid">${formatFileSize(file.size)}</p>
                        <div class="file-actions">
                            ${!file.inTrash ? `<i data-feather="trash-2" class="trash-icon" onclick="moveToTrash(${file.id})"></i>` : ''}
                            ${file.inTrash ? `<i data-feather="refresh-cw" class="restore-icon" onclick="restoreFromTrash(${file.id})"></i>` : ''}
                        </div>
                    `;
                    filesContainer.appendChild(div);
                });
            }

            // Replace all feather icons with SVG
            feather.replace();
        }

        async function moveToTrash(fileId) {
            try {
                await actor.moveFileToTrash(fileId);
                renderFiles();
            } catch (error) {
                console.error('Error moving file to trash:', error);
            }
        }

        async function restoreFromTrash(fileId) {
            try {
                await actor.restoreFileFromTrash(fileId);
                renderFiles();
            } catch (error) {
                console.error('Error restoring file from trash:', error);
            }
        }

        function setActiveMenuItem(clickedItem) {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            clickedItem.classList.add('active');
        }

        // Upload Modal
        const modal = document.getElementById("uploadModal");
        const btn = document.getElementById("uploadBtn");
        const span = document.getElementsByClassName("close")[0];
        const dropArea = document.getElementById("dropArea");
        const fileInput = document.getElementById("fileInput");
        const categorySelect = document.getElementById("categorySelect");

        btn.onclick = function() {
            modal.style.display = "block";
        }

        span.onclick = function() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        dropArea.ondragover = function(e) {
            e.preventDefault();
            this.style.backgroundColor = "#f0f0f0";
        }

        dropArea.ondragleave = function() {
            this.style.backgroundColor = "";
        }

        dropArea.ondrop = function(e) {
            e.preventDefault();
            this.style.backgroundColor = "";
            handleFiles(e.dataTransfer.files);
        }

        dropArea.onclick = function() {
            fileInput.click();
        }

        fileInput.onchange = function() {
            handleFiles(this.files);
        }

        async function handleFiles(files) {
            for (let file of files) {
                try {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        const content = new Uint8Array(e.target.result);
                        const category = categorySelect.value || detectCategory(file);
                        await actor.uploadFile(file.name, file.type, file.size, category, content);
                    };
                    reader.readAsArrayBuffer(file);
                } catch (error) {
                    console.error('Error uploading file:', error);
                }
            }
            modal.style.display = "none";
            renderFiles();
        }

        function detectCategory(file) {
            const fileType = file.type.split('/')[0];
            switch(fileType) {
                case 'image':
                    return 'photos';
                case 'video':
                    return 'videos';
                case 'audio':
                    return 'audio';
                case 'application':
                case 'text':
                    return 'documents';
                default:
                    return 'other';
            }
        }

        function getFileIcon(fileType) {
            const type = fileType.split('/')[0];
            switch(type) {
                case 'image': return 'image';
                case 'video': return 'film';
                case 'audio': return 'music';
                case 'application':
                case 'text':
                    return 'file-text';
                default:
                    return 'file';
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
            else return (bytes / 1073741824).toFixed(1) + ' GB';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await initializeActor();
            renderFiles();
            feather.replace();

            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', async (event) => {
                    event.preventDefault();
                    setActiveMenuItem(item);
                    const category = item.dataset.section;
                    const currentCategoryElement = document.getElementById('currentCategory');
                    if (category === 'home') {
                        currentCategory = 'all';
                        currentCategoryElement.textContent = 'My Files';
                    } else if (['photos', 'videos', 'documents', 'audio', 'trash'].includes(category)) {
                        currentCategory = category;
                        currentCategoryElement.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                    } else {
                        console.log('Clicked on:', category);
                    }
                    await renderFiles();
                });
            });

            setViewMode('list');
        });

        const canisterInterface = {
          // Add your canister interface here
        };
    </script>
</body>
</html>
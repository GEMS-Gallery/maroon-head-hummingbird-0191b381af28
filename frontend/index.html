<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileBox</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.28.0/feather.min.js"></script>
    <script src="https://unpkg.com/@dfinity/agent@0.15.1/lib/index.js"></script>
    <script src="https://unpkg.com/@dfinity/candid@0.15.1/lib/index.js"></script>
    <style>
        /* ... (styles remain unchanged) ... */
    </style>
</head>
<body>
    <!-- ... (HTML structure remains unchanged) ... -->

    <script>
        let actor;
        let currentViewMode = 'list';
        let currentCategory = 'all';

        const canisterInterface = {
            getFiles: () => [],
            getTrashFiles: () => [],
            getFilesByCategory: (category) => [],
            uploadFile: (name, fileType, size, category, content) => ({ ok: 0 }),
            moveFileToTrash: (id) => ({ ok: null }),
            restoreFileFromTrash: (id) => ({ ok: null }),
            createFolder: (name) => ({ ok: 0 }),
            deleteFolder: (id) => ({ ok: null }),
        };

        async function initializeActor() {
            const canisterId = 'rrkah-fqaaa-aaaaa-aaaaq-cai'; // Replace with your actual canister ID
            try {
                const agent = new window.ic.agent.HttpAgent();
                await agent.fetchRootKey();
                actor = window.ic.actor.createActor(canisterInterface, { agent, canisterId });
            } catch (error) {
                console.error('Error initializing actor:', error);
            }
        }

        async function fetchFiles() {
            if (!actor) {
                console.error('Actor not initialized');
                return [];
            }
            try {
                if (currentCategory === 'all' || currentCategory === 'my-files') {
                    return await actor.getFiles();
                } else if (currentCategory === 'trash') {
                    return await actor.getTrashFiles();
                } else {
                    return await actor.getFilesByCategory(currentCategory);
                }
            } catch (error) {
                console.error('Error fetching files:', error);
                return [];
            }
        }

        function setViewMode(mode) {
            currentViewMode = mode;
            document.getElementById('gridViewBtn').classList.toggle('active', mode === 'grid');
            document.getElementById('listViewBtn').classList.toggle('active', mode === 'list');
            renderFiles();
        }

        async function renderFiles() {
            const filesContainer = document.getElementById('filesContainer');
            filesContainer.innerHTML = '';
            
            const files = await fetchFiles();
            
            if (currentViewMode === 'list') {
                filesContainer.className = 'files-list';
                files.forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'file-item';
                    li.innerHTML = `
                        <img src="data:image/png;base64,${arrayBufferToBase64(file.content)}" alt="${file.name} preview" class="file-preview">
                        <i data-feather="${getFileIcon(file.fileType)}" class="file-icon icon-${getFileIcon(file.fileType)}"></i>
                        <div class="file-details">
                            <p class="file-name">${file.name}</p>
                            <p class="file-info">${formatFileSize(file.size)} - ${file.category}</p>
                        </div>
                        <div class="file-actions">
                            ${!file.inTrash ? `<i data-feather="trash-2" class="trash-icon" onclick="moveToTrash(${file.id})"></i>` : ''}
                            ${file.inTrash ? `<i data-feather="refresh-cw" class="restore-icon" onclick="restoreFromTrash(${file.id})"></i>` : ''}
                        </div>
                    `;
                    filesContainer.appendChild(li);
                });
            } else {
                filesContainer.className = 'files-grid';
                files.forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'file-item-grid';
                    div.innerHTML = `
                        <img src="data:image/png;base64,${arrayBufferToBase64(file.content)}" alt="${file.name} preview" class="file-preview-grid">
                        <p class="file-name-grid">${file.name}</p>
                        <p class="file-info-grid">${formatFileSize(file.size)}</p>
                        <div class="file-actions">
                            ${!file.inTrash ? `<i data-feather="trash-2" class="trash-icon" onclick="moveToTrash(${file.id})"></i>` : ''}
                            ${file.inTrash ? `<i data-feather="refresh-cw" class="restore-icon" onclick="restoreFromTrash(${file.id})"></i>` : ''}
                        </div>
                    `;
                    filesContainer.appendChild(div);
                });
            }

            // Replace all feather icons with SVG
            feather.replace();
        }

        async function moveToTrash(fileId) {
            if (!actor) {
                console.error('Actor not initialized');
                return;
            }
            try {
                await actor.moveFileToTrash(fileId);
                renderFiles();
            } catch (error) {
                console.error('Error moving file to trash:', error);
            }
        }

        async function restoreFromTrash(fileId) {
            if (!actor) {
                console.error('Actor not initialized');
                return;
            }
            try {
                await actor.restoreFileFromTrash(fileId);
                renderFiles();
            } catch (error) {
                console.error('Error restoring file from trash:', error);
            }
        }

        function setActiveMenuItem(clickedItem) {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            clickedItem.classList.add('active');
        }

        // Upload Modal
        const modal = document.getElementById("uploadModal");
        const btn = document.getElementById("uploadBtn");
        const span = document.getElementsByClassName("close")[0];
        const dropArea = document.getElementById("dropArea");
        const fileInput = document.getElementById("fileInput");
        const categorySelect = document.getElementById("categorySelect");

        btn.onclick = function() {
            modal.style.display = "block";
        }

        span.onclick = function() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        dropArea.ondragover = function(e) {
            e.preventDefault();
            this.style.backgroundColor = "#f0f0f0";
        }

        dropArea.ondragleave = function() {
            this.style.backgroundColor = "";
        }

        dropArea.ondrop = function(e) {
            e.preventDefault();
            this.style.backgroundColor = "";
            handleFiles(e.dataTransfer.files);
        }

        dropArea.onclick = function() {
            fileInput.click();
        }

        fileInput.onchange = function() {
            handleFiles(this.files);
        }

        async function handleFiles(files) {
            if (!actor) {
                console.error('Actor not initialized');
                return;
            }
            for (let file of files) {
                try {
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        const content = new Uint8Array(e.target.result);
                        const category = categorySelect.value || detectCategory(file);
                        await actor.uploadFile(file.name, file.type, file.size, category, content);
                    };
                    reader.readAsArrayBuffer(file);
                } catch (error) {
                    console.error('Error uploading file:', error);
                }
            }
            modal.style.display = "none";
            renderFiles();
        }

        function detectCategory(file) {
            const fileType = file.type.split('/')[0];
            switch(fileType) {
                case 'image':
                    return 'photos';
                case 'video':
                    return 'videos';
                case 'audio':
                    return 'audio';
                case 'application':
                case 'text':
                    return 'documents';
                default:
                    return 'other';
            }
        }

        function getFileIcon(fileType) {
            const type = fileType.split('/')[0];
            switch(type) {
                case 'image': return 'image';
                case 'video': return 'film';
                case 'audio': return 'music';
                case 'application':
                case 'text':
                    return 'file-text';
                default:
                    return 'file';
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
            else return (bytes / 1073741824).toFixed(1) + ' GB';
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await initializeActor();
            await renderFiles();
            feather.replace();

            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', async (event) => {
                    event.preventDefault();
                    setActiveMenuItem(item);
                    const category = item.dataset.section;
                    const currentCategoryElement = document.getElementById('currentCategory');
                    if (category === 'home') {
                        currentCategory = 'all';
                        currentCategoryElement.textContent = 'My Files';
                    } else if (['photos', 'videos', 'documents', 'audio', 'trash'].includes(category)) {
                        currentCategory = category;
                        currentCategoryElement.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                    } else {
                        console.log('Clicked on:', category);
                    }
                    await renderFiles();
                });
            });

            setViewMode('list');
        });
    </script>
</body>
</html>